<div class="messaging-app">
   <div *ngIf="showAlert"
                 class="alert"
                 [ngClass]="{'alert-success': alertType==='success', 'alert-danger': alertType==='danger'}"
                 role="alert">
              {{ alertMessage }}
              <button type="button" class="btn-close" (click)="closeAlert()"></button>
            </div>

  <!-- Header √©l√©gant -->
  <div class="app-header">
    <div class="header-content">
      <div class="header-brand">
        <div class="brand-icon">
          <i class="bi bi-chat-heart-fill"></i>
        </div>
        <div class="brand-text">
          <h1 class="app-title">Messagerie Parent</h1>
          <p class="app-subtitle">Communiquez avec les enseignants et l'administration</p>
        </div>
      </div>

      <div class="header-stats">
        <div class="stat-item">
          <div class="stat-icon">
            <i class="bi bi-envelope-open"></i>
          </div>
          <div class="stat-content">
            <span class="stat-number">{{ messagesRecus.length }}</span>
            <span class="stat-label">Messages re√ßus</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-icon">
            <i class="bi bi-bell"></i>
          </div>
          <div class="stat-content">
            <span class="stat-number text-danger">{{ unreadCount }}</span>
            <span class="stat-label text-danger" >Non lus</span>
          </div>
        </div>
        <button class="btn-refresh" (click)="refreshMessages()" title="Actualiser">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Navigation √©l√©gante -->
  <div class="tab-navigation">
    <div class="tab-container">
      <button class="tab-item"
              [class.active]="currentSection === 'composer'"
              (click)="currentSection = 'composer'">
        <div class="tab-icon">
          <i class="bi bi-pencil-square"></i>
        </div>
        <span>Nouveau Message</span>
      </button>

      <button class="tab-item"
              [class.active]="currentSection === 'recus'"
              (click)="currentSection = 'recus'">
        <div class="tab-icon">
          <i class="bi bi-inbox"></i>
          <span *ngIf="unreadCount > 0" class="tab-badge text-danger" >{{ unreadCount }}</span>
        </div>
        <span>Bo√Æte de r√©ception</span>
      </button>

      <button class="tab-item"
              [class.active]="currentSection === 'envoyes'"
              (click)="currentSection = 'envoyes'">
        <div class="tab-icon">
          <i class="bi bi-send-check"></i>
        </div>
        <span>Messages envoy√©s</span>
      </button>
    </div>
  </div>

  <!-- Contenu principal -->
  <div class="app-content">

    <!-- Section Composition -->
    <section *ngIf="currentSection === 'composer'" class="composer-section">
      <div class="composer-card">
        <div class="card-header">
          <div class="header-icon">
            <i class="bi bi-pencil-square"></i>
          </div>
          <div class="header-text">
            <h2 class="card-title">Nouveau Message</h2>
            <p class="card-subtitle">Envoyez un message √† un enseignant ou √† l'administration</p>
          </div>
        </div>

        <form [formGroup]="messageForm" (ngSubmit)="sendMessage()" class="composer-form">

          <!-- Type de destinataire -->
          <div class="form-section">
            <label class="section-label">Destinataire</label>
            <div class="recipient-type-selector">
              <div class="type-options">
                <label class="type-option" [class.active]="messageForm.get('destinataire_type')?.value === 'prof'">
                  <input type="radio" formControlName="destinataire_type" value="prof">
                  <div class="option-content">
                    <div class="option-icon">
                      <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="option-text">
                      <strong>Professeur</strong>
                      <span>Contacter le professeur de votre enfant</span>
                    </div>
                  </div>
                </label>

                <label class="type-option" [class.active]="messageForm.get('destinataire_type')?.value === 'admin'">
                  <input type="radio" formControlName="destinataire_type" value="admin">
                  <div class="option-content">
                    <div class="option-icon">
                      <i class="bi bi-building-gear"></i>
                    </div>
                    <div class="option-text">
                      <strong>Administration</strong>
                      <span>Demande administrative ou technique</span>
                    </div>
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- S√©lection du professeur -->
          <div class="form-section" *ngIf="messageForm.get('destinataire_type')?.value === 'prof'">
            <div class="form-group">
              <label class="form-label">
                <i class="bi bi-person-lines-fill"></i>
                S√©lectionner un professeur
              </label>
              <div class="select-wrapper">
                <select formControlName="prof_id" class="modern-select">
                  <option value="" disabled selected>üë®‚Äçüè´ Choisir un enseignant...</option>
                  <option *ngFor="let prof of professeurs" [value]="prof.user_id">
                    {{ prof.user.prenom }} {{ prof.user.nom }} - {{ prof.matiere.nom }}
                  </option>
                </select>
                <i class="bi bi-chevron-down select-arrow"></i>
              </div>
              <div class="error-message" *ngIf="messageForm.get('prof_id')?.invalid && messageForm.get('prof_id')?.touched">
                <i class="bi bi-exclamation-circle"></i>
                Veuillez s√©lectionner un professeur
              </div>
            </div>
          </div>

          <!-- Section administration -->
          <div class="form-section" *ngIf="messageForm.get('destinataire_type')?.value === 'admin'">
            <div class="admin-info-card">
              <div class="info-icon">
                <i class="bi bi-info-circle"></i>
              </div>
              <div class="info-content">
                <h4>Message √† l'administration</h4>
                <p>Pour toute question concernant l'√©tablissement, les absences, les documents administratifs, etc.</p>
              </div>
            </div>

            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">
                  <i class="bi bi-tags"></i>
                  Cat√©gorie
                </label>
                <select formControlName="categorie" class="modern-select">
                  <option value="" selected>üìã Choisir une cat√©gorie...</option>
                  <option value="absence">üìù Absence / Retard</option>
                  <option value="document">üìÑ Document administratif</option>
                  <option value="scolarite">üéì Scolarit√©</option>
                  <option value="technique">üîß Probl√®me technique</option>
                  <option value="autre">‚ùì Autre demande</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="bi bi-flag"></i>
                  Priorit√©
                </label>
                <select formControlName="priorite" class="modern-select">
                  <option value="normal">üü¢ Normale</option>
                  <option value="haute">üü† Haute</option>
                  <option value="urgent">üî¥ Urgente</option>
                </select>
              </div>
            </div>
          </div>

          <!-- D√©tails du message -->
          <div class="form-section">
            <div class="form-group full-width">
              <label class="form-label">
                <i class="bi bi-chat-square-text"></i>
                Objet du message
              </label>
              <input type="text"
                     formControlName="objet"
                     class="modern-input"
                     placeholder="Saisissez l'objet de votre message...">
              <div class="error-message" *ngIf="messageForm.get('objet')?.invalid && messageForm.get('objet')?.touched">
                <i class="bi bi-exclamation-circle"></i>
                <span *ngIf="messageForm.get('objet')?.errors?.['required']">L'objet est obligatoire</span>
                <span *ngIf="messageForm.get('objet')?.errors?.['minlength']">L'objet doit faire au moins 3 caract√®res</span>
              </div>
            </div>

            <div class="form-group full-width">
              <label class="form-label">
                <i class="bi bi-chat-left-text"></i>
                Message
              </label>
              <div class="textarea-container">
                <textarea formControlName="contenu"
                          rows="6"
                          class="modern-textarea"
                          placeholder="R√©digez votre message ici..."></textarea>
                <div class="textarea-footer">
                  <div class="char-counter">
                    {{ messageForm.get('contenu')?.value?.length || 0 }} caract√®res
                  </div>
                  <div class="help-text">
                    <i class="bi bi-info-circle"></i>
                    Soyez pr√©cis dans votre demande
                  </div>
                </div>
              </div>
              <div class="error-message" *ngIf="messageForm.get('contenu')?.invalid && messageForm.get('contenu')?.touched">
                <i class="bi bi-exclamation-circle"></i>
                <span *ngIf="messageForm.get('contenu')?.errors?.['required']">Le message est obligatoire</span>
                <span *ngIf="messageForm.get('contenu')?.errors?.['minlength']">Le message doit faire au moins 10 caract√®res</span>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="resetForm()">
              <i class="bi bi-x-circle"></i>
              Annuler
            </button>
            <button type="submit"
                    class="btn btn-primary"
                    [disabled]="messageForm.invalid">
              <i class="bi bi-send-fill"></i>
              {{ getButtonText() }}
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- Section Messages Re√ßus -->
    <section *ngIf="currentSection === 'recus'" class="messages-section">
      <div class="messages-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="bi bi-inbox"></i>
          </div>
          <div class="header-text">
            <h2 class="section-title">Bo√Æte de r√©ception</h2>
            <div class="messages-stats">
              <span class="stat-text">{{ filteredMessages.length }} message(s)</span>
              <span *ngIf="unreadCount > 0" class="unread-stat text-danger">{{ unreadCount }} non lu(s)</span>
            </div>
          </div>
        </div>
        <div class="header-controls">
          <div class="filter-control">
            <select class="modern-select compact" (change)="filterMessages($event)">
              <option value="all">Tous les messages</option>
              <option value="unread">Non lus uniquement</option>
              <option value="prof">Enseignants</option>
              <option value="admin">Administration</option>
            </select>
          </div>
        </div>
      </div>

      <div class="messages-list">
        <!-- √âtat vide -->
        <div *ngIf="filteredMessages.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-inbox"></i>
          </div>
          <h3>Aucun message</h3>
          <p>Vous n'avez pas encore re√ßu de messages</p>
          <button class="btn btn-primary" (click)="currentSection = 'composer'">
            <i class="bi bi-pencil-square"></i>
            √âcrire un message
          </button>
        </div>

        <!-- Liste des messages -->
        <div *ngFor="let msg of filteredMessages"
             class="message-card"
             [class.unread]="msg.statut === 'non_lu'"
             [class.selected]="selectedMessage?.id === msg.id"
             (click)="selectMessage(msg)">

          <div class="message-indicator" [ngClass]="'type-' + msg.type"></div>

          <div class="message-content">
            <div class="message-header">
              <div class="message-sender">
                <div class="sender-avatar" [ngClass]="msg.expediteur_type">
                  <i [class]="getAvatarIcon(msg)"></i>
                </div>
                <div class="sender-info">
                  <h4 class="sender-name">
                    {{ getExpediteurName(msg.expediteur_id) }}
                  </h4>
                  <div class="message-type-tag" [ngClass]="getTypeClass(msg)">
                    {{ getTypeLabel(msg) }}
                  </div>
                </div>
              </div>

              <div class="message-meta">
                <div class="message-time">
                  {{ msg.created_at | date:'dd/MM/yyyy √† HH:mm' }}
                </div>
                <div class="message-status" [ngClass]="getStatusClass(msg)">
                  {{ getStatusLabel(msg) }}
                </div>
              </div>
            </div>

            <div class="message-subject">
              <h3 class="subject-text">{{ msg.objet || 'Sans objet' }}</h3>
              <div class="message-actions">

                <button class="action-btn reply"
                        (click)="repondreMessage(msg); $event.stopPropagation()"
                        title="R√©pondre">
                  <i class="bi bi-reply"></i>
                </button>
              </div>
            </div>

            <div class="message-preview">
              <p>{{ msg.contenu | truncate:120 }}</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section Messages Envoy√©s -->
    <section *ngIf="currentSection === 'envoyes'" class="messages-section">
      <div class="messages-header">
        <div class="header-content">
          <div class="header-icon">
            <i class="bi bi-send-check"></i>
          </div>
          <div class="header-text">
            <h2 class="section-title">Messages envoy√©s</h2>
            <div class="messages-stats">
              <span class="stat-text">{{ messagesEnvoyes.length }} message(s) envoy√©(s)</span>
            </div>
          </div>
        </div>
      </div>

      <div class="messages-list">
        <div *ngIf="messagesEnvoyes.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-send"></i>
          </div>
          <h3>Aucun message envoy√©</h3>
          <p>Vous n'avez pas encore envoy√© de messages</p>
          <button class="btn btn-primary" (click)="currentSection = 'composer'">
            <i class="bi bi-pencil-square"></i>
            √âcrire votre premier message
          </button>
        </div>

        <div *ngFor="let msg of messagesEnvoyes"
             class="message-card sent">
          <div class="message-indicator sent"></div>

          <div class="message-content">
            <div class="message-header">
              <div class="message-sender">
                <div class="sender-avatar sent">
                  <i [class]="getDestAvatarIcon(msg)"></i>
                </div>
                <div class="sender-info">
                  <h4 class="sender-name">√Ä : {{getDestinataireInfo(msg) }}</h4>
                  <div class="message-type-tag" [ngClass]="getTypeClass(msg)">
                    {{ getTypeLabel(msg) }}
                  </div>
                </div>
              </div>

              <div class="message-meta">
                <div class="message-time">
                  {{ msg.created_at | date:'dd/MM/yyyy √† HH:mm' }}
                </div>
                <div class="sent-indicator">
                  <i class="bi bi-check-circle-fill"></i>
                  Envoy√©
                </div>
              </div>
            </div>

            <div class="message-subject">
              <h3 class="subject-text">{{ msg.objet || 'Sans objet' }}</h3>
            </div>

            <div class="message-preview">
              <p>{{ msg.contenu | truncate:120 }}</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>





<!-- UN SEUL MODAL CORRIG√â -->
<div *ngIf="selectedMessage" class="modern-modal-overlay" (click)="closeMessageModal()">
  <div class="modern-modal" (click)="$event.stopPropagation()">

    <!-- Header de la modal -->
    <div class="modern-modal-header"
         [class.type-urgence]="selectedMessage.type === 'urgence'"
         [class.type-annonce]="selectedMessage.type === 'annonce'">
      <div class="header-background"></div>
      <div class="header-content">
        <div class="message-header-info">
          <div class="message-type-indicator">
            <div class="type-icon">
              <i class="bi" [ngClass]="{
                'bi-envelope': selectedMessage.type === 'message',
                'bi-megaphone': selectedMessage.type === 'annonce',
                'bi-exclamation-triangle': selectedMessage.type === 'urgence'
              }"></i>
            </div>
            <div class="type-info">
              <div class="type-label">{{ getTypeLabel(selectedMessage) }}</div>
              <div class="message-date">{{ selectedMessage.created_at | date:'dd/MM/yyyy √† HH:mm' }}</div>
            </div>
          </div>

          <div class="header-actions">
            <button class="action-btn close-btn" (click)="closeMessageModal()" title="Fermer">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>

        <h1 class="modern-modal-title">{{ selectedMessage.objet }}</h1>

        <div class="message-quick-info">
          <div class="info-item">
            <i class="bi bi-person"></i>
            <span>
              <strong *ngIf="currentSection === 'recus'">De: </strong>
              <strong *ngIf="currentSection === 'envoyes'">√Ä: </strong>
              {{ currentSection === 'recus' ?
                 getExpediteurName(selectedMessage.expediteur_id) :
                 getDestinataireInfo(selectedMessage) }}
            </span>
          </div>

          <div *ngIf="selectedMessage.priorite" class="info-item">
            <i class="bi bi-flag"></i>
            <span class="priority-tag" [ngClass]="selectedMessage.priorite">
              Priorit√© {{ selectedMessage.priorite }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Corps de la modal -->
    <div class="modern-modal-body">
      <div class="message-content-section">
        <div class="section-header">
          <h3>Contenu du message</h3>
          <div class="message-stats">
            <span class="char-count">{{ selectedMessage.contenu.length || 0 }} caract√®res</span>
          </div>
        </div>

        <div class="message-text-content">
          <div class="text-scroll-container">
            <p>{{ selectedMessage.contenu }}</p>
          </div>
        </div>
      </div>

      <!-- M√©tadonn√©es -->
      <div class="metadata-section">
        <div class="section-header">
          <h3>Informations</h3>
        </div>

        <div class="metadata-grid">
          <div class="metadata-card">
            <div class="metadata-icon">
              <i class="bi" [ngClass]="{
                'bi-person-shield': currentSection === 'recus' && selectedMessage.expediteur_type === 'admin',
                'bi-person-badge': currentSection === 'recus' && selectedMessage.expediteur_type === 'prof',
                'bi-person': currentSection === 'recus' && selectedMessage.expediteur_type === 'parent',
                'bi-send': currentSection === 'envoyes'
              }"></i>
            </div>
            <div class="metadata-content">
              <label>{{ currentSection === 'recus' ? 'Exp√©diteur' : 'Destinataire' }}</label>
              <div class="metadata-value">
                {{ currentSection === 'recus' ?
                   getExpediteurName(selectedMessage.expediteur_id) :
                   getDestinataireInfo(selectedMessage) }}
              </div>
              <div class="metadata-subtext">
                {{ currentSection === 'recus' ? selectedMessage.expediteur_type : selectedMessage.role_destinataire }}
              </div>
            </div>
          </div>

          <div class="metadata-card">
            <div class="metadata-icon">
              <i class="bi bi-tag"></i>
            </div>
            <div class="metadata-content">
              <label>Type</label>
              <div class="metadata-value">
                <span class="type-tag" [ngClass]="getTypeBadgeClass(selectedMessage.type)">
                  {{ getTypeLabel(selectedMessage) }}
                </span>
              </div>
            </div>
          </div>

          <div *ngIf="selectedMessage.priorite" class="metadata-card">
            <div class="metadata-icon">
              <i class="bi bi-flag"></i>
            </div>
            <div class="metadata-content">
              <label>Priorit√©</label>
              <div class="metadata-value">
                <span class="priority-tag" [ngClass]="selectedMessage.priorite">
                  {{ selectedMessage.priorite }}
                </span>
              </div>
            </div>
          </div>

          <div class="metadata-card">
            <div class="metadata-icon">
              <i class="bi bi-calendar"></i>
            </div>
            <div class="metadata-content">
              <label>Date d'envoi</label>
              <div class="metadata-value">
                {{ selectedMessage.created_at | date:'dd/MM/yyyy √† HH:mm' }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer de la modal -->
    <div class="modern-modal-footer">
      <div class="footer-actions">
        <button class="btn btn-secondary" (click)="closeMessageModal()">
          <i class="bi bi-x"></i>
          Fermer
        </button>

        <!-- Bouton R√©pondre uniquement pour les messages re√ßus -->
        <button *ngIf="currentSection === 'recus'"
                class="btn btn-primary"
                (click)="repondreMessage(selectedMessage); closeMessageModal()">
          <i class="bi bi-reply"></i>
          R√©pondre
        </button>

        <!-- Bouton R√©utiliser uniquement pour les messages envoy√©s -->
        <button *ngIf="currentSection === 'envoyes'"
                class="btn btn-outline"
                (click)="resendMessage(selectedMessage); closeMessageModal()">
          <i class="bi bi-share"></i>
          R√©utiliser
        </button>
      </div>
    </div>
  </div>
</div>
